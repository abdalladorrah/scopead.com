<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KPI Dashboard — Fixed ECharts sync</title>

  <!-- external CSS (استخدمت ملف المشروع الأصلي) -->
  <link rel="stylesheet" href="css/style.css" />

  <!-- external libs (احتفظت بـChart.js لأن المشروع الأصلي بيستخدمه) -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- ECharts (خيار للعرض الحديث) -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
</head>
<body>
  <div class="container">
    <header class="page-header">
      <div class="header-left">
        <h1>KPI Dashboard</h1>
      </div>
      <div class="header-actions">
        <button id="openFiltersBtn" class="btn small" title="Open Filters">Filters</button>
      </div>
    </header>

    <div class="layout">
      <aside class="sidebar modal" id="sidebarModal" aria-hidden="true" role="dialog" aria-label="Filters & Platforms">
        <div class="side-card">
          <div class="modal-header">
            <h3>Filters</h3>
            <button id="closeFiltersBtn" class="btn small" title="Close Filters">Close</button>
          </div>

          <div class="side-card-section">
            <label>
              CSV File
              <input id="fileInput" type="file" accept=".csv" title="Upload CSV (optional)"/>
              <small>If no file uploaded, the CSV from project will be used</small>
            </label>
          </div>

          <div class="side-card-section">
            <label>
              Quick Range
              <select id="presetSelect" class="small" title="Quick range presets">
                <option value="custom">Custom</option>
                <option value="7">Last 7 days</option>
                <option value="14">Last 14 days</option>
                <option value="30">Last 30 days</option>
                <option value="month">This month</option>
                <option value="all">All</option>
              </select>
            </label>
          </div>

          <div class="side-card-section">
            <label>
              Date Range
              <input id="dateRange" type="text" placeholder="Select range" />
              <input id="dateFrom" type="hidden" />
              <input id="dateTo" type="hidden" />
            </label>
          </div>

          <div class="filters-actions">
            <button id="applyRange" class="btn" title="Apply Range">Apply</button>
            <button id="resetBtn" class="btn" title="Reset">Reset</button>
          </div>
        </div>

        <div class="side-card">
          <h3>Platforms</h3>
          <div id="platformTabs" class="tabs"></div>
        </div>
      </aside>

      <div id="modalBackdrop" class="modal-backdrop" tabindex="-1" aria-hidden="true"></div>

      <main class="main">
        <h2 class="section-title" id="metricsTitle">Platform Metrics</h2>

        <!-- TOP 4 KPI cards (no previous-period comparison; descriptors only) -->
        <section class="kpi-grid">
          <div class="card platform-metric-card kpi-enhanced">
            <div style="display:flex; align-items:center; gap:12px;">
              <div class="kpi-icon" title="Total Spend">
                <!-- wallet svg -->
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 7h18v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z" stroke="currentColor" stroke-width="1.2"/></svg>
              </div>
              <div>
                <h4 class="kpi-label">Total Spend</h4>
                <div id="kpiSpend" class="kpi-value">-</div>
                <div class="metric-sub">Total amount spent (EGP)</div>
              </div>
            </div>
          </div>

          <div class="card platform-metric-card kpi-enhanced">
            <div style="display:flex; align-items:center; gap:12px;">
              <div class="kpi-icon" title="Purchases">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 3h2l.4 2M7 13h10l3-8H6.4" stroke="currentColor" stroke-width="1.2"/></svg>
              </div>
              <div>
                <h4 class="kpi-label">Purchases</h4>
                <div id="kpiPurchases" class="kpi-value">-</div>
                <div class="metric-sub">Number of purchases</div>
              </div>
            </div>
          </div>

          <div class="card platform-metric-card kpi-enhanced">
            <div style="display:flex; align-items:center; gap:12px;">
              <div class="kpi-icon" title="Purchase Value">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 1v22" stroke="currentColor" stroke-width="1.2"/></svg>
              </div>
              <div>
                <h4 class="kpi-label">Purchase Value</h4>
                <div id="kpiPurchaseValue" class="kpi-value">-</div>
                <div class="metric-sub">Total revenue from purchases (EGP)</div>
              </div>
            </div>
          </div>

          <div class="card platform-metric-card kpi-enhanced">
            <div style="display:flex; align-items:center; gap:12px;">
              <div class="kpi-icon" title="ROAS">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 12A9 9 0 1 0 3 12" stroke="currentColor" stroke-width="1.2"/></svg>
              </div>
              <div>
                <h4 class="kpi-label">ROAS</h4>
                <div id="kpiROAS" class="kpi-value">-</div>
                <div class="metric-sub">Return on ad spend</div>
              </div>
            </div>
          </div>
        </section>

        <!-- BOTTOM metric cards (same look as top) -->
        <section id="platformMetrics" class="platform-metric-grid" aria-live="polite"></section>

        <div id="crossPlatformContainer">
          <h2 class="section-title">Cross-Platform Comparison</h2>

          <section class="grid-2">
            <div class="card">
              <h4>Spend Over Time</h4>

              <!-- IMPORTANT: kept original canvas id so app.js draws into it -->
              <canvas id="tsChartAll"></canvas>

              <!-- ECharts mirror container (separate id) -->
              <div id="tsChartAll_echarts" style="width:100%;height:320px; display:none;"></div>

              <div id="tsMsgAll" class="note"></div>
            </div>

            <div class="card">
              <h4>Conversion Funnel (All Platforms)</h4>
              <div style="height: 400px;">
                <canvas id="allFunnelChart"></canvas>
                <div id="allFunnelChart_echarts" style="width:100%;height:320px; display:none;"></div>
              </div>
            </div>

            <div class="card">
              <h4>Impressions & Spend by Platform</h4>
              <canvas id="barChartAll"></canvas>
              <div id="barChartAll_echarts" style="width:100%;height:320px; display:none;"></div>
              <div id="barMsgAll" class="note"></div>
            </div>
          </section>

          <div class="grid-2" style="margin-bottom:12px; margin-top:12px;">
            <div class="card">
              <h4>Impressions by Platform</h4>
              <canvas id="cmpImprChart"></canvas>
              <div id="cmpImprChart_echarts" style="width:100%;height:320px; display:none;"></div>
            </div>
            <div class="card">
              <h4>Reach by Platform</h4>
              <canvas id="cmpReachChart"></canvas>
              <div id="cmpReachChart_echarts" style="width:100%;height:320px; display:none;"></div>
            </div>
          </div>

          <div class="grid-2" style="margin-bottom:12px">
            <div class="card">
              <h4>Link Clicks by Platform</h4>
              <canvas id="cmpClicksChart"></canvas>
              <div id="cmpClicksChart_echarts" style="width:100%;height:320px; display:none;"></div>
            </div>
            <div class="card">
              <h4>ATC by Platform</h4>
              <canvas id="cmpATCChart"></canvas>
              <div id="cmpATCChart_echarts" style="width:100%;height:320px; display:none;"></div>
            </div>
          </div>

          <div class="grid-2" style="margin-bottom:12px">
            <div class="card">
              <h4>Purchase Value by Platform</h4>
              <canvas id="cmpPurchValChart"></canvas>
              <div id="cmpPurchValChart_echarts" style="width:100%;height:320px; display:none;"></div>
            </div>
            <div class="card">
              <h4>Purchases by Platform</h4>
              <canvas id="cmpPurchChart"></canvas>
              <div id="cmpPurchChart_echarts" style="width:100%;height:320px; display:none;"></div>
            </div>
          </div>

          <div class="card">
            <h4>Initial Checkpoints by Platform</h4>
            <canvas id="cmpLandingChart"></canvas>
            <div id="cmpLandingChart_echarts" style="width:100%;height:320px; display:none;"></div>
          </div>
        </div>

        <div id="singlePlatformContainer" style="display: none;">
          <h2 class="section-title" id="singlePlatformTitle">Platform Analytics</h2>

          <section class="grid-2">
            <div class="card">
              <h4>Spend Over Time</h4>
              <canvas id="spSpendChart"></canvas>
              <div id="spSpendChart_echarts" style="width:100%;height:320px; display:none;"></div>
              <div id="spSpendMsg" class="note"></div>
            </div>
            <div class="card">
              <h4>Purchases Over Time</h4>
              <canvas id="spPurchChart"></canvas>
              <div id="spPurchChart_echarts" style="width:100%;height:320px; display:none;"></div>
              <div id="spPurchMsg" class="note"></div>
            </div>
          </section>

          <section class="grid-2" style="margin-top: 20px;">
            <div class="card" style="grid-column: span 2;">
              <h4>Conversion Funnel</h4>
              <div style="height: 400px;">
                <canvas id="spFunnelChart"></canvas>
                <div id="spFunnelChart_echarts" style="width:100%;height:400px; display:none;"></div>
              </div>
            </div>
            <div class="card" style="grid-column: span 2; margin-top: 20px;">
              <h4>CPA Over Time</h4>
              <canvas id="spCPAChart"></canvas>
              <div id="spCPAChart_echarts" style="width:100%;height:320px; display:none;"></div>
              <div id="spCPAMsg" class="note"></div>
            </div>
          </section>
        </div>

      </main>
    </div>
  </div>

  <!-- Modal toggle -->
  <script>
    (function(){
      const openBtn = document.getElementById('openFiltersBtn');
      const closeBtn = document.getElementById('closeFiltersBtn');
      const modal = document.getElementById('sidebarModal');
      const backdrop = document.getElementById('modalBackdrop');

      function openModal(){ modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); backdrop.classList.add('open'); backdrop.setAttribute('aria-hidden','false'); }
      function closeModal(){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); backdrop.classList.remove('open'); backdrop.setAttribute('aria-hidden','true'); }

      openBtn && openBtn.addEventListener('click', openModal);
      closeBtn && closeBtn.addEventListener('click', closeModal);
      backdrop && backdrop.addEventListener('click', closeModal);
      document.addEventListener('keydown', function(e){ if(e.key === 'Escape' && modal.classList.contains('open')) closeModal(); });
    })();
  </script>

  <!-- flatpickr init -->
  <script>
    document.addEventListener("DOMContentLoaded", function(){
      flatpickr("#dateRange", {
        mode:"range",
        dateFormat:"Y-m-d",
        onClose:function(sel){
          const df=document.getElementById('dateFrom');
          const dt=document.getElementById('dateTo');
          if(sel.length===2){ df.value=sel[0].toISOString().slice(0,10); dt.value=sel[1].toISOString().slice(0,10); }
          else if(sel.length===1){ df.value=sel[0].toISOString().slice(0,10); dt.value=""; }
          else { df.value=""; dt.value=""; }
          const preset=document.getElementById('presetSelect');
          if(preset) preset.value='custom';
          if(typeof renderWithCurrentFilters==='function') renderWithCurrentFilters();
        }
      });
    });
  </script>

  <!-- SYNC: mirror Chart.js -> ECharts (no defaults). This polls for Chart.js instances created by app.js and creates/updates ECharts accordingly. -->
  <script>
  (function syncChartJsToEcharts(){
  if(typeof echarts === 'undefined' || typeof Chart === 'undefined') return;

  const MAP = [
    { canvas: 'tsChartAll', echarts: 'tsChartAll_echarts', type:'line' },
    { canvas: 'barChartAll', echarts: 'barChartAll_echarts', type:'bar' },
    { canvas: 'allFunnelChart', echarts: 'allFunnelChart_echarts', type:'funnel' },
    { canvas: 'cmpImprChart', echarts: 'cmpImprChart_echarts', type:'bar' },
    { canvas: 'cmpReachChart', echarts: 'cmpReachChart_echarts', type:'bar' },
    { canvas: 'cmpClicksChart', echarts: 'cmpClicksChart_echarts', type:'bar' },
    { canvas: 'cmpATCChart', echarts: 'cmpATCChart_echarts', type:'bar' },
    { canvas: 'cmpPurchValChart', echarts: 'cmpPurchValChart_echarts', type:'bar' },
    { canvas: 'cmpPurchChart', echarts: 'cmpPurchChart_echarts', type:'bar' },
    { canvas: 'cmpLandingChart', echarts: 'cmpLandingChart_echarts', type:'bar' },
    { canvas: 'spSpendChart', echarts: 'spSpendChart_echarts', type:'line' },
    { canvas: 'spPurchChart', echarts: 'spPurchChart_echarts', type:'line' },
    { canvas: 'spFunnelChart', echarts: 'spFunnelChart_echarts', type:'funnel' },
    { canvas: 'spCPAChart', echarts: 'spCPAChart_echarts', type:'line' }
  ];

  const instances = {};

  function buildOptionFromChartJs(chartInstance, preferredType){
    if(!chartInstance || !chartInstance.data) return null;
    const labels = chartInstance.data.labels || [];
    const datasets = chartInstance.data.datasets || [];

    if(preferredType === 'funnel'){
      const ds = datasets[0];
      if(!ds) return null;
      const data = labels.map((lab,i)=> ({ name: String(lab), value: Number(ds.data[i] || 0) }));
      return { tooltip:{ trigger:'item' }, series:[{ type:'funnel', data }] };
    }

    const series = datasets.map(ds => ({
      name: ds.label || '',
      type: preferredType === 'bar' ? 'bar' : 'line',
      data: (ds.data || []).map(v => Number(v || 0)),
      smooth: preferredType !== 'bar',
      showSymbol: false,
      areaStyle: preferredType === 'line' ? {} : undefined
    }));

    return {
      tooltip:{ trigger:'axis' },
      xAxis:{ type:'category', data: labels },
      yAxis:{ type:'value' },
      grid:{ left:'6%', right:'6%', bottom:'10%', top:'10%' },
      series
    };
  }

  function syncOne(m){
    const canvas = document.getElementById(m.canvas);
    const div = document.getElementById(m.echarts);
    if(!div) return;

    if(!instances[m.echarts]){
      instances[m.echarts] = echarts.init(div);
      // ensure resize on window resize
      window.addEventListener('resize', ()=> instances[m.echarts].resize());
    }
    const chartE = instances[m.echarts];

    // try to get Chart.js instance
    let ch = null;
    try { ch = Chart.getChart(canvas); } catch(e){ ch = null; }
    if(!ch && canvas && canvas.__chart) ch = canvas.__chart;

    if(!ch){
      // no Chart.js data yet -> hide ECharts container and clear
      chartE.clear();
      div.style.display = 'none';
      if(canvas) canvas.style.display = ''; // show original canvas if it's used
      return;
    }

    // build echarts option and apply
    const opt = buildOptionFromChartJs(ch, m.type);
    if(opt){
      // show echarts, hide original canvas (so user sees ECharts)
      div.style.display = 'block';
      if(canvas) canvas.style.display = 'none';

      chartE.setOption(opt, { notMerge: true });

      // important: force a resize after rendering to pick correct width/height
      // small timeout to wait DOM repaint; also try requestAnimationFrame for safety
      setTimeout(() => {
        try{ chartE.resize(); } catch(e){}
        requestAnimationFrame(()=> {
          try{ chartE.resize(); } catch(e){}
        });
      }, 40);
    }
  }

  // poller - picks up chart instances created by app.js
  const POLL_INTERVAL = 800;
  const poller = setInterval(()=> {
    MAP.forEach(syncOne);
  }, POLL_INTERVAL);

  // stop polling after some time (keeps page responsive)
  setTimeout(()=> clearInterval(poller), 1000 * 60 * 4);

  // helper to trigger manual sync after your app updates Chart.js
  window.syncChartJsToEchartsNow = function(){ MAP.forEach(syncOne); };

  // initial attempt
  MAP.forEach(syncOne);
})();
  </script>

  <!-- Keep original project scripts (these populate the canvases) -->
  <script src="js/dataUtils.js"></script>
  <script src="js/app.js"></script>

  <footer class="page-footer">
    <p>Done with Love ❤️ by <strong>Ninja , Yousef & Elkhal</strong></p>
  </footer>

</body>
</html>
