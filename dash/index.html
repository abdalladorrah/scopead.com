<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>KPI Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="css/style.css" />

  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>

<body>
  <div class="container">

    <!-- HEADER -->
    <header class="page-header">
      <h1>KPI Dashboard</h1>
      <button id="openFiltersBtn" class="btn small">Filters</button>
    </header>

    <div class="layout">

      <!-- SIDEBAR -->
      <aside class="sidebar modal" id="sidebarModal">
        <div class="side-card">
          <div class="modal-header">
            <h3>Filters</h3>
            <button id="closeFiltersBtn" class="btn small">Close</button>
          </div>

          <label>CSV File
            <input id="fileInput" type="file" accept=".csv" />
          </label>

          <label>Quick Range
            <select id="presetSelect">
              <option value="all">All</option>
              <option value="7">Last 7 days</option>
              <option value="14">Last 14 days</option>
              <option value="30">Last 30 days</option>
              <option value="month">This month</option>
              <option value="custom">Custom</option>
            </select>
          </label>

          <label>Date Range
            <input id="dateRange" type="text" />
            <input id="dateFrom" type="hidden" />
            <input id="dateTo" type="hidden" />
          </label>

          <button id="applyRange" class="btn">Apply</button>
          <button id="resetBtn" class="btn">Reset</button>
        </div>

        <div class="side-card">
          <h3>Platforms</h3>
          <div id="platformTabs" class="tabs"></div>
        </div>
      </aside>

      <div id="modalBackdrop" class="modal-backdrop"></div>

      <!-- MAIN -->
      <main class="main">

        <!-- 1. TOP CARDS (Spend, Purch, Value, ROAS) -->
        <section class="kpi-grid">
          <div class="card">
            <h4>Total Spend</h4>
            <div id="kpiSpend" class="kpi-value">-</div>
            <div class="sub-text">Total amount spent</div>
          </div>
          <div class="card">
            <h4>Purchases</h4>
            <div id="kpiPurchases" class="kpi-value">-</div>
            <div class="sub-text">Number of purchases</div>
          </div>
          <div class="card">
            <h4>Purchase Value</h4>
            <div id="kpiPurchaseValue" class="kpi-value">-</div>
            <div class="sub-text">Total revenue from purchases</div>
          </div>
          <div class="card">
            <h4>ROAS</h4>
            <div id="kpiROAS" class="kpi-value">-</div>
            <div class="sub-text">Return on ad spend</div>
          </div>
        </section>

        <!-- 2. DETAILED GRID (Imp, Reach, Clicks, Landing, ATC, IC, Purch, CPA, CPM, Freq, Avgs) -->
        <section id="metricsGrid" class="kpi-grid" style="grid-template-columns: repeat(4, 1fr); margin-top: 20px;">
          <!-- Will be populated by JS -->
        </section>

        <!-- 3. CHARTS SECTION (Mixed Time Series & Funnels) -->
        <section class="charts-section" style="margin-top: 20px;">
          <!-- Row 1: Spend+Sales (Dual Axis) & CPA -->
          <div class="chart-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div class="card">
              <div id="spendSalesChart_echarts" style="height:350px;"></div>
            </div>
            <div class="card">
              <div id="cpaChart_echarts" style="height:350px;"></div>
            </div>
          </div>

          <!-- Row 2: Funnels -->
          <div class="chart-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="card">
              <h5>Funnel: Reach & Traffic</h5>
              <div id="funnel1Chart_echarts" style="height:400px;"></div>
            </div>
            <div class="card">
              <h5>Funnel: Conversion</h5>
              <div id="funnel2Chart_echarts" style="height:400px;"></div>
            </div>
          </div>
        </section>

        <!-- 4. COMPARISON SECTION (Only visible if Platform == 'All') -->
        <section id="comparisonSection" style="margin-top: 40px;">
          <h2>Platform Comparisons</h2>

          <div class="chart-grid"
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
            <div class="card">
              <div id="compImpSpendChart" style="height:300px"></div>
            </div>
            <div class="card">
              <div id="compClicksChart" style="height:300px"></div>
            </div>
            <div class="card">
              <div id="compATCChart" style="height:300px"></div>
            </div>
            <div class="card">
              <div id="compValueChart" style="height:300px"></div>
            </div>
            <div class="card">
              <div id="compPurchChart" style="height:300px"></div>
            </div>
          </div>
        </section>

      </main>
    </div>
  </div>

  <!-- Modal logic -->
  <script>
    const openBtn = document.getElementById("openFiltersBtn");
    const closeBtn = document.getElementById("closeFiltersBtn");
    const modal = document.getElementById("sidebarModal");
    const backdrop = document.getElementById("modalBackdrop");

    openBtn.onclick = () => {
      modal.classList.add("open");
      backdrop.classList.add("open");
    };
    closeBtn.onclick = backdrop.onclick = () => {
      modal.classList.remove("open");
      backdrop.classList.remove("open");
    };
  </script>

  <!-- ✅ Flatpickr (LOCAL DATE – NO UTC) -->
  <script>
    function toLocalDate(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    flatpickr("#dateRange", {
      mode: "range",
      dateFormat: "Y-m-d",
      onClose: d => {
        document.getElementById("dateFrom").value =
          d[0] ? toLocalDate(d[0]) : "";

        document.getElementById("dateTo").value =
          d[1] ? toLocalDate(d[1]) : "";
      }
    });
  </script>

  <script type="module" src="app/app.js"></script>
</body>

</html>